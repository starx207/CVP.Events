@page "/"
@using CVP.Events.Api.Sdk.Requests
@using CVP.Events.Models
@rendermode InteractiveServer

@inject IEventsApi _eventsApi

<PageTitle>Events - CVP Events</PageTitle>

<div class="events-page">
    <div class="page-header">
        <h1 class="page-title">Upcoming Events</h1>
        <p class="page-subtitle">Discover and explore our events</p>
        <div class="page-actions">
            <a href="/newevent" class="btn btn-primary">
                Create New Event
            </a>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (events is not { Length: > 0 })
    {
        <div class="alert alert-info" role="alert">
            No events found.
        </div>
    }
    else
    {
        <EventTable Items="@events" />
        <PageSelect PageSize="@pageSize" ItemCount="@eventTotal" />
    }

    @if (errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <strong>Error:</strong> @errorMessage
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private int pageSize = 2;
    private EventItemVM[]? events;
    private int eventTotal;

    [Parameter]
    [SupplyParameterFromQuery(Name = "page")]
    public int CurrentPage { get; set; }

    protected override Task OnParametersSetAsync() => LoadEventsAsync();

    private async Task LoadEventsAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var request = new GetAllEventsRequest
            {
                Page = Math.Max(CurrentPage, 1),
                PageSize = pageSize
            };

            var response = await _eventsApi.GetEventsAsync(request);
            events = response.ToItemViewModel();
            eventTotal = response.Total;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load events: {ex.Message}";
            events = null;
        }
        finally
        {
            isLoading = false;
        }
    }
}
