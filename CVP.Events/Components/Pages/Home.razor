@page "/"
@using CVP.Events.Api.Sdk.Requests
@using CVP.Events.Models
@rendermode InteractiveServer

@inject IEventsApi _eventsApi
@inject NavigationManager _navManager

<PageTitle>Events - CVP Events</PageTitle>

<div class="events-page">
    <div class="page-header">
        <h1 class="page-title">Upcoming Events</h1>
        <p class="page-subtitle">Discover and explore our events</p>
        <div class="page-actions">
            <a href="/newevent" class="btn btn-primary">
                Create New Event
            </a>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (events is not { Length: > 0 })
    {
        <div class="alert alert-info" role="alert">
            No events found.
        </div>
    }
    else
    {
        <div class="search-controls">
            <div class="search-bar">
                <div class="search-input-group">
                    <input type="text" class="form-control search-input" placeholder="Search for title..." @bind="@searchTerm" />
                    <button type="button" class="btn btn-primary search-button" @onclick="Search">
                        <i class="bi bi-search"></i>
                        Search
                    </button>
                </div>
            </div>
            <div class="sort-controls">
                <select id="sortSelect" class="form-select sort-select" @onchange="SortChanged">
                    @foreach (var option in sortOptions)
                    {
                        <option value="@option" selected="@(option == selectedSortOption)">Sort: @option.ToDisplayName()</option>
                    }
                </select>
            </div>
        </div>

        <EventTable Items="@events" />
        <PageSelect CurrentPage="@CurrentPage" PageSize="@pageSize" ItemCount="@eventTotal" OnPageChange="PageChange" />
    }

    @if (errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <strong>Error:</strong> @errorMessage
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private int pageSize = 2;
    private EventItemVM[]? events;
    private int eventTotal;
    private SortOption selectedSortOption;
    private SortOption[] sortOptions = Enum.GetValues<SortOption>();

    [Parameter]
    [SupplyParameterFromQuery(Name = "page")]
    public int CurrentPage { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "filter")]
    public string? searchTerm { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "sort")]
    public string? QuerySort { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        selectedSortOption = Enum.TryParse<SortOption>(QuerySort, true, out var option) ? option : SortOption.StartDateDesc;
        CurrentPage = Math.Max(1, CurrentPage); // If not defined, we'll default to the first page
        await LoadEventsAsync();
    }

    private async Task LoadEventsAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var request = new GetAllEventsRequest
            {
                Page = Math.Max(CurrentPage, 1),
                PageSize = pageSize,
                OrderBy = selectedSortOption.ToSortQuery(),
                Filter = searchTerm?.ToTitleFilter()
            };

            var response = await _eventsApi.GetEventsAsync(request);
            events = response.ToItemViewModel();
            eventTotal = response.Total;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load events: {ex.Message}";
            events = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void PageChange(int newPage)
    {
        if (newPage == CurrentPage)
        {
            return;
        }
        _navManager.NavigateTo(
            _navManager.GetUriWithQueryParameter("page", newPage)
        );
    }

    private void SortChanged(ChangeEventArgs e)
    {
        if (!Enum.TryParse<SortOption>(e.Value?.ToString(), out var newOption))
        {
            return;
        }

        if (newOption == selectedSortOption)
        {
            return; // No change
        }

        _navManager.NavigateTo(
            _navManager.GetUriWithQueryParameter("sort", newOption.ToString())
        );
    }

    private void Search()
    {
        _navManager.NavigateTo(
            _navManager.GetUriWithQueryParameter("filter", string.IsNullOrEmpty(searchTerm) ? null : searchTerm)
        );
    }
}
